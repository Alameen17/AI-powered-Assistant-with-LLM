@page "/history"
@using AI_Powered_Code_Review_Assistant.Models
@inject IJSRuntime JSRuntime
@inject NavigationManager Navigation

<PageTitle>Review History - AI Code Review</PageTitle>

<div class="page-content">
    <!-- Animated Background -->
    <div class="animated-bg"></div>

    <div class="container py-5 position-relative">
        <!-- Enhanced Header -->
        <div class="text-center mb-5 fade-in-down">
            <h1 class="display-4 fw-bold text-white mb-3">
                <i class="fas fa-history me-3"></i>Review History
            </h1>
            <p class="lead text-white-50">Track your code analysis progress and insights</p>
        </div>

        <!-- Stats Cards -->
        <div class="row section-spacing fade-in-up">
            <div class="col-lg-3 col-md-6">
                <div class="stat-card">
                    <div class="stat-value text-white">@totalReviews</div>
                    <div class="stat-label">Total Reviews</div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="stat-card">
                    <div class="stat-value" style="color: #4ecdc4;">@avgScore</div>
                    <div class="stat-label">Average Score</div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="stat-card">
                    <div class="stat-value" style="color: #ffd93d;">@issuesFixed</div>
                    <div class="stat-label">Issues Fixed</div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="stat-card">
                    <div class="stat-value" style="color: #4facfe;">@timeSaved</div>
                    <div class="stat-label">Hours Saved</div>
                </div>
            </div>
        </div>

        <!-- Filter and Search -->
        <div class="content-card fade-in-up">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
                    <h5 class="mb-0">
                        <i class="fas fa-filter me-2"></i>Filter Reviews
                    </h5>
                    <div class="d-flex gap-2">
                        <input type="text" class="form-control" placeholder="Search reviews..." @bind="searchQuery" @oninput="FilterReviews" style="width: 250px;">
                        <select class="form-select" @bind="selectedFilter" @bind:after="FilterReviews" style="width: auto;">
                            <option value="all">All Reviews</option>
                            <option value="recent">Recent (30 days)</option>
                            <option value="high-score">High Score (A-B)</option>
                            <option value="issues">With Issues</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- History List -->
        <div class="content-card fade-in-up">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-list me-2"></i>Recent Reviews (@filteredReviews.Count)
                </h5>
            </div>
            <div class="card-body">
                @if (filteredReviews.Any())
                {
                    @foreach (var review in filteredReviews)
                    {
                        <div class="history-item" @onclick="() => ViewReview(review)">
                            <div class="history-header">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div class="flex-grow-1">
                                        <h6 class="history-title">
                                            <i class="fas fa-folder-open me-2"></i>
                                            @GetDisplayPath(review.RepoPath)
                                        </h6>
                                        <div class="history-meta">
                                            <span class="meta-item">
                                                <i class="fas fa-calendar me-1"></i>
                                                @review.CreatedAt.ToString("MMM dd, yyyy HH:mm")
                                            </span>
                                            <span class="meta-item">
                                                <i class="fas fa-file-code me-1"></i>
                                                @review.Summary.TotalFiles files
                                            </span>
                                            <span class="meta-item">
                                                <i class="fas fa-stopwatch me-1"></i>
                                                @review.Duration.TotalSeconds.ToString("F1")s
                                            </span>
                                        </div>
                                    </div>
                                    <div class="history-score">
                                        <div class="score-badge" style="@GetScoreColor(review.Summary.OverallScore)">
                                            @GetScoreGrade(review.Summary.OverallScore)
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="history-summary">
                                <div class="summary-stats">
                                    <div class="summary-stat">
                                        <span class="stat-number" style="color: #ff6b6b;">@review.Summary.CriticalIssues</span>
                                        <span class="stat-text">Critical</span>
                                    </div>
                                    <div class="summary-stat">
                                        <span class="stat-number" style="color: #ffd93d;">@review.Summary.HighIssues</span>
                                        <span class="stat-text">High</span>
                                    </div>
                                    <div class="summary-stat">
                                        <span class="stat-number" style="color: #4ecdc4;">@review.Summary.MediumIssues</span>
                                        <span class="stat-text">Medium</span>
                                    </div>
                                    <div class="summary-stat">
                                        <span class="stat-number" style="color: #95a5a6;">@review.Summary.LowIssues</span>
                                        <span class="stat-text">Low</span>
                                    </div>
                                </div>
                                @if (review.Summary.TopRecommendations.Any())
                                {
                                    <div class="top-recommendation">
                                        <i class="fas fa-lightbulb me-2"></i>
                                        @review.Summary.TopRecommendations.First()
                                    </div>
                                }
                            </div>
                        </div>
                    }
                }
                else
                {
                    <div class="empty-state">
                        <div class="empty-icon">
                            <i class="fas fa-history"></i>
                        </div>
                        <h5 class="text-white mb-2">No Review History</h5>
                        <p class="text-light mb-4">
                            @if (string.IsNullOrEmpty(searchQuery))
                            {
                                <text>You haven't performed any code reviews yet. Start your first review to see it here.</text>
                            }
                            else
                            {
                                <text>No reviews match your search criteria. Try adjusting your filters.</text>
                            }
                        </p>
                        <button class="btn btn-primary" @onclick="StartNewReview">
                            <i class="fas fa-plus me-2"></i>Start New Review
                        </button>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

<style>
    .page-content {
        /* Inheriting from app.css */
    }

    .animated-bg {
        position: absolute;
        width: 100%;
        height: 100%;
        opacity: 0.1;
        background-image:
            repeating-linear-gradient(45deg, transparent, transparent 35px, rgba(255,255,255,.1) 35px, rgba(255,255,255,.1) 70px);
        animation: backgroundScroll 20s linear infinite;
    }

    @@keyframes backgroundScroll {
        0% { transform: translateX(0); }
        100% { transform: translateX(70px); }
    }

    .stat-card {
        background: rgba(255, 255, 255, 0.15);
        backdrop-filter: blur(15px);
        border: 1px solid rgba(255, 255, 255, 0.25);
        border-radius: 20px;
        padding: 2rem;
        text-align: center;
        transition: all 0.3s ease;
        box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
        height: 100%;
    }

    .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 12px 40px rgba(31, 38, 135, 0.5);
    }

    .stat-value {
        font-size: 3rem;
        font-weight: 800;
        margin-bottom: 0.5rem;
        text-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }

    .stat-label {
        color: rgba(255,255,255,0.9);
        font-weight: 600;
        font-size: 1rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .content-card {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 20px;
        box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
        overflow: hidden;
        margin-bottom: 2rem;
    }

    .content-card .card-header {
        background: rgba(255, 255, 255, 0.15);
        border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        padding: 1.5rem;
        border-radius: 0;
    }

    .content-card .card-header h5 {
        color: #fff;
        font-weight: 700;
        margin: 0;
        text-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }

    .content-card .card-body {
        padding: 0;
        background: rgba(255, 255, 255, 0.05);
    }

    .history-item {
        padding: 1.5rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        transition: all 0.3s ease;
        cursor: pointer;
    }

    .history-item:hover {
        background: rgba(255, 255, 255, 0.1);
        transform: translateX(5px);
    }

    .history-item:last-child {
        border-bottom: none;
    }

    .history-title {
        color: #fff;
        font-weight: 600;
        margin-bottom: 0.5rem;
        text-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }

    .history-meta {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
    }

    .meta-item {
        color: rgba(255, 255, 255, 0.8);
        font-size: 0.875rem;
        display: flex;
        align-items: center;
    }

    .history-score {
        display: flex;
        align-items: center;
    }

    .score-badge {
        padding: 0.5rem 1rem;
        border-radius: 15px;
        font-weight: 700;
        font-size: 1.1rem;
        background: rgba(255, 255, 255, 0.2);
        color: white;
        backdrop-filter: blur(5px);
        border: 1px solid rgba(255, 255, 255, 0.3);
    }

    .history-summary {
        margin-top: 1rem;
    }

    .summary-stats {
        display: flex;
        gap: 1.5rem;
        margin-bottom: 1rem;
    }

    .summary-stat {
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
    }

    .stat-number {
        font-size: 1.5rem;
        font-weight: 700;
        line-height: 1;
    }

    .stat-text {
        color: rgba(255, 255, 255, 0.8);
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .top-recommendation {
        color: rgba(255, 255, 255, 0.9);
        font-style: italic;
        padding: 0.75rem;
        background: rgba(78, 205, 196, 0.1);
        border-radius: 10px;
        border-left: 4px solid #4ecdc4;
    }

    .empty-state {
        text-align: center;
        padding: 4rem 2rem;
    }

    .empty-icon {
        font-size: 4rem;
        color: rgba(255, 255, 255, 0.4);
        margin-bottom: 1.5rem;
    }

    .section-spacing {
        margin-bottom: 3rem;
    }

    .fade-in-down {
        animation: fadeInDown 0.8s ease;
    }

    .fade-in-up {
        animation: fadeInUp 0.8s ease;
    }

    @@keyframes fadeInDown {
        from {
            opacity: 0;
            transform: translateY(-20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    @@keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* Responsive Design */
    @@media (max-width: 768px) {
        .summary-stats {
            justify-content: center;
        }

        .history-meta {
            flex-direction: column;
            gap: 0.5rem;
        }

        .d-flex.justify-content-between {
            flex-direction: column;
            gap: 1rem;
        }
    }
</style>

@code {
    private List<ReviewResult> allReviews = new();
    private List<ReviewResult> filteredReviews = new();
    private string searchQuery = "";
    private string selectedFilter = "all";

    // Mock statistics
    private int totalReviews = 47;
    private string avgScore = "B+";
    private int issuesFixed = 234;
    private int timeSaved = 156;

    protected override Task OnInitializedAsync()
    {
        LoadMockData();
        filteredReviews = allReviews;
        return Task.CompletedTask;
    }

    private void LoadMockData()
    {
        // In a real application, this would load from a database
        allReviews = new List<ReviewResult>
        {
            new ReviewResult
            {
                RepoPath = "C:\\Projects\\E-Commerce-Platform",
                CreatedAt = DateTime.Now.AddDays(-1),
                Duration = TimeSpan.FromSeconds(45.2),
                Summary = new ReviewSummary
                {
                    TotalFiles = 23,
                    TotalIssues = 8,
                    CriticalIssues = 1,
                    HighIssues = 2,
                    MediumIssues = 3,
                    LowIssues = 2,
                    OverallScore = "B+ (85%)",
                    TopRecommendations = new List<string> { "Consider implementing input validation for user forms" }
                },
                Reviews = new List<AI_Powered_Code_Review_Assistant.Models.Review>()
            },
            new ReviewResult
            {
                RepoPath = "C:\\Projects\\Customer-Management-API",
                CreatedAt = DateTime.Now.AddDays(-3),
                Duration = TimeSpan.FromSeconds(67.8),
                Summary = new ReviewSummary
                {
                    TotalFiles = 15,
                    TotalIssues = 12,
                    CriticalIssues = 2,
                    HighIssues = 4,
                    MediumIssues = 4,
                    LowIssues = 2,
                    OverallScore = "C+ (72%)",
                    TopRecommendations = new List<string> { "Add error handling for database operations" }
                },
                Reviews = new List<AI_Powered_Code_Review_Assistant.Models.Review>()
            },
            new ReviewResult
            {
                RepoPath = "C:\\Projects\\Mobile-App-Backend",
                CreatedAt = DateTime.Now.AddDays(-7),
                Duration = TimeSpan.FromSeconds(92.4),
                Summary = new ReviewSummary
                {
                    TotalFiles = 31,
                    TotalIssues = 3,
                    CriticalIssues = 0,
                    HighIssues = 1,
                    MediumIssues = 1,
                    LowIssues = 1,
                    OverallScore = "A- (92%)",
                    TopRecommendations = new List<string> { "Excellent code quality, minor performance optimizations suggested" }
                },
                Reviews = new List<AI_Powered_Code_Review_Assistant.Models.Review>()
            }
        };
    }

    private void FilterReviews()
    {
        filteredReviews = allReviews.Where(review =>
        {
            // Search filter
            if (!string.IsNullOrEmpty(searchQuery))
            {
                var searchLower = searchQuery.ToLower();
                if (!review.RepoPath.ToLower().Contains(searchLower))
                    return false;
            }

            // Category filter
            return selectedFilter switch
            {
                "recent" => review.CreatedAt >= DateTime.Now.AddDays(-30),
                "high-score" => review.Summary.OverallScore.StartsWith("A") || review.Summary.OverallScore.StartsWith("B"),
                "issues" => review.Summary.TotalIssues > 0,
                _ => true
            };
        }).ToList();

        StateHasChanged();
    }

    private string GetDisplayPath(string fullPath)
    {
        var parts = fullPath.Split(new[] { '\\', '/' }, StringSplitOptions.RemoveEmptyEntries);
        return parts.Length > 0 ? parts.Last() : fullPath;
    }

    private string GetScoreColor(string score) => score switch
    {
        var s when s.StartsWith("A") => "background: linear-gradient(135deg, #4ecdc4, #44a08d);",
        var s when s.StartsWith("B") => "background: linear-gradient(135deg, #4facfe, #00f2fe);",
        var s when s.StartsWith("C") => "background: linear-gradient(135deg, #ffd93d, #ff9f43);",
        var s when s.StartsWith("D") => "background: linear-gradient(135deg, #ff9f43, #ff6b6b);",
        _ => "background: linear-gradient(135deg, #ff6b6b, #ee5a52);"
    };

    private string GetScoreGrade(string score) => score.Split(' ')[0];

    private async Task ViewReview(ReviewResult review)
    {
        // Store the result in session state and navigate to results
        var resultJson = System.Text.Json.JsonSerializer.Serialize(review);
        await JSRuntime.InvokeVoidAsync("sessionStorage.setItem", "reviewResult", resultJson);
        Navigation.NavigateTo("/results");
    }

    private void StartNewReview()
    {
        Navigation.NavigateTo("/review");
    }
}